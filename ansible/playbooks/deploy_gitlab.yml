---
- name: Deploy GitLab on Multiple Platforms
  hosts: localhost
  become: yes
  gather_facts: yes

  vars_files:
    - ../vars/deployment_config.yml

  pre_tasks:
    - name: Load deployment configuration
      include_vars:
        file: "{{ playbook_dir }}/../../config/deployment_config.json"
        name: deployment

  tasks:
    - name: Include platform-specific tasks
      include_tasks: "{{ ansible_os_family | lower }}_setup.yml"
      when: ansible_os_family is defined

    - name: Create GitLab directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /srv/gitlab/config
        - /srv/gitlab/logs
        - /srv/gitlab/data

    - name: Install Docker (Linux)
      include_role:
        name: docker
      when: ansible_os_family in ['Debian', 'RedHat', 'Archlinux']

    - name: Install Docker (macOS)
      include_tasks: macos_docker.yml
      when: ansible_os_family == 'Darwin'

    - name: Install Docker (Windows)
      include_tasks: windows_docker.yml
      when: ansible_os_family == 'Windows'

    - name: Wait for Docker to be ready
      command: docker info
      register: docker_info
      until: docker_info.rc == 0
      retries: 5
      delay: 10

    - name: Display deployment summary
      debug:
        msg:
          - "GitLab deployment started"
          - "Domain: {{ deployment.domain }}"
          - "Platform: {{ deployment.platform }}"
          - "OS Version: {{ deployment.os_version }}"
          - "Let's Encrypt: {{ deployment.letsencrypt_enabled }}"
